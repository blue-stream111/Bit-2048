本次开发的Bit2048是基于经典2048改编的Qt图形界面益智游戏，在原版合并规则基础上扩展了**位运算方块、炸弹、黑洞、对数方块**等特殊元素，同时实现了存档读档、步数撤回、排行榜、计时计分等核心功能，整体采用C++结合Qt框架开发，遵循面向对象的设计思想。

## 一、项目整体架构
项目采用**分层式模块化设计**，分为**界面展示层、游戏核心逻辑层、数据存储层**三大核心层级，各层级通过Qt的**信号与槽机制**实现通信，保证代码的可维护性和扩展性。

整体架构关系如下：

```plain
界面展示层：start窗口、MainWindow游戏主窗口、saveForm存档窗口、MyLabel自定义格子
    ↕ 信号与槽通信
游戏核心逻辑层：Game游戏核心类（含规则、移动、生成、判定）
    ↕ 数据交互
数据存储层：排行榜、存档（rank.json, file.json以及HistoryFilex.json）
```

## 二、核心模块代码分析及设计思路
### （一）入口模块：main.cpp
**核心功能**：初始化Qt应用、创建所有窗口实例、建立跨模块的信号与槽连接，定义程序的窗口显示逻辑。

1. 创建启动窗口`start`、游戏主窗口`MainWindow`、存档窗口`saveForm`三个核心界面实例；
2. 建立关键通信连接：
    - 启动窗口的「存档」按钮触发存档窗口的显示；
    - 存档窗口的「返回」触发启动窗口的显示，「加载存档」触发游戏主窗口的读档逻辑；
    - 启动窗口的「开始游戏」触发游戏主窗口的初始化；
    - 游戏主窗口的「返回」触发启动窗口的显示，「保存游戏」触发存档窗口的写入逻辑；

### （二）界面展示模块
该模块是用户与游戏的交互入口，基于Qt的QWidget/QMainWindow实现，包含**启动窗口、游戏主窗口、存档窗口**子模块，所有界面均重写`paintEvent`实现背景图绘制，保证视觉统一性。

#### 1. 启动窗口：start.h/start.cpp
**核心功能**：游戏启动页，提供「开始游戏」「游戏帮助」「退出游戏」「读取存档」四个核心功能按钮。

+ 「游戏帮助」通过QMessageBox展示游戏规则；
+ 提供`getBack`槽函数，接收其他窗口的「返回」信号并重新显示自身；
+ 通过信号`startGame`/`getSavings`触发游戏主窗口/存档窗口的启动。

#### 2. 游戏主窗口：MainWindow.h/MainWindow.cpp
**核心功能**：游戏展示核心界面，集成**棋盘显示、计时计分、排行榜、功能按钮、键盘操作**所有游戏交互逻辑，是界面层的核心。

##### 关键成员与功能
+ 棋盘：通过Qt的`gridLayout`布局，结合自定义`MyLabel`实现4×4的游戏格子，与`Game`类的4×4（BOARD_WIDTH × BOARD_LENGTH）数据矩阵一一对应；
+ 计时：通过`QTimer`实现1秒一次的计时，`showInfo`槽函数更新界面时间显示，`handleTime`实现秒数到【X分钟X秒】的格式化；
+ 计分/步数：实时展示`Game`类的分数和步数，每次移动后通过`drawBoard`刷新；
+ 排行榜：定义`SCORE`结构体存储玩家名、分数、时间，重写`<`运算符实现**分数降序、同分时间升序**的排序规则，`loadRank`/`saveRank`实现排行榜的json读写；
+ 功能按钮：开始/重新开始、暂停/继续、返回、撤回上一步、保存游戏，每个按钮绑定对应的业务逻辑槽函数；
+ 键盘事件：重写`keyPressEvent`，支持W/A/S/D/方向键控制移动、R重新开始、Q退出游戏，符合玩家操作习惯；
+ 核心槽函数：`drawBoard`是界面刷新的核心，遍历`Game`类的4×4数据矩阵，调用`MyLabel`的`match`方法实现格子的样式、内容与游戏数据的同步。
+ `gameIsOn`标志位：控制游戏的运行状态，避免无游戏时的对空指针进行操作；
+ `openNewGame`：统一处理「新游戏」和「读档游戏」的初始化，创建`Game`实例并建立与`Game`类的信号连接（胜利/失败）；
+ `gameOver`：游戏结束的统一处理，停止计时、断开与`Game`类的连接、释放`Game`实例、更新排行榜；
+ 信号与槽：接收`Game`类的`win`/`lose`信号，弹出结算提示框并展示**用时、得分、最大方块**；接收`MyLabel`的`bomb`信号，触发游戏内的炸弹效果。

#### 3. 存档窗口：saveForm.h/saveForm.cpp
**核心功能**：实现游戏的**存档展示、加载、删除、清空**，基于QListWidget展示所有存档信息。

+ `init`：核心函数，遍历`data/save/historySavings`目录下的存档json文件，解析存档的玩家名、用时、得分、步数并展示在列表中；
+ `record`：接收游戏主窗口的保存信号，将当前游戏的步骤数据、玩家信息写入新的存档json文件，文件命名为`HistoryFilex.json`（x为存档序号）；
+ `onSaveItemClicked`：加载选中的存档，将文件路径通过信号传递给游戏主窗口；
+ 右键菜单：重写`contextMenuEvent`，实现单个存档的删除功能，删除后自动重排剩余存档的序号；
+ 批量操作：提供「清空所有存档」按钮，遍历删除所有存档文件并刷新列表。

#### 4. 相关部件：自定义格子MyLabel.h/MyLabel.cpp
**核心功能**：4×4棋盘中的单个格子，继承QLabel并扩展**样式定制、内容显示、鼠标事件**，是棋盘的最小展示单元。

+ 核心成员：关联`Game`类的`Num`结构体，存储格子的坐标`x/y`，实现与游戏数据的绑定；
+ `match`：接收`Game`类的`Num`数据，根据数据类型更新格子的**内容、背景色、文字色**；
+ `setColor`：根据格子的类型（数字/炸弹/黑洞/位运算）设置不同的背景色，数字方块根据数值匹配经典2048的渐变色彩，提升视觉辨识度；
+ `toBinary`：将十进制数字转换为**4位补零的二进制字符串**，符合Bit2048的核心设计要求；
+ `mousePressEvent`：处理鼠标点击事件，实现特殊方块的**锁定/解锁**，炸弹方块解锁时触发`bomb`信号，通知游戏主窗口执行炸弹效果；
+ `setTxt`：根据特殊方块的类型（BARRIER/BOMB/BLACKHOLE/LG2/AND/OR/XOR）展示对应的文字，锁定状态标注`(Locked)`，解锁状态标注`(Unlocked)`。

### （三）游戏核心逻辑模块：Game.h/Game.cpp
**核心功能**：实现Bit2048的**所有游戏规则**，包括棋盘初始化、方块移动、合并、生成、胜利/失败判定、特殊方块效果、步数撤回、数据保存，是整个项目的**业务核心**，与界面层完全解耦，仅通过接口提供数据、通过信号通知状态

#### 1. 核心数据结构
+ `enum gameState`：游戏状态枚举（WIN/LOSE/CONTINUE），用于胜利/失败判定；
+ `enum MyNumType`：方块类型枚举（NUMBER/炸弹/AND/OR/XOR/黑洞/LG2/障碍物），覆盖所有游戏方块；
+ `struct Num`：单个方块的数据结构，包含**类型、锁定状态、数值**，是棋盘的最小数据单元；
+ `Num data[BOARD_WIDTH][BOARD_LENGTH]`：4×4的棋盘数据矩阵，与界面层的4×4`MyLabel`一一对应；
+ 核心属性：分数`score`、用时`time`、步数`steps`、最大方块值`maxVal`、游戏运行状态`full`（棋盘是否填满）。

#### 2. 核心初始化逻辑
+ 无参构造`Game()`：初始化新游戏，清空步骤文件、初始化4×4数据矩阵、启动计时器、随机生成两个初始方块（90%1，10%2）、保存初始步骤；
+ 有参构造`Game(QString filePath)`：读档初始化，解析存档json文件，恢复棋盘数据、分数、用时、步数、玩家名，将存档的步骤数据恢复到临时步骤文件。

#### 3. 核心游戏规则
##### （1）方块移动与合并
实现`moveLeft/moveRight/moveUp/moveDown`四个方向的移动逻辑，整体分为**合并阶段**和**移动阶段**，严格遵循经典2048的规则并扩展特殊方块效果：

1. 合并阶段：遍历棋盘，找到非空的相邻方块，若满足**均未锁定**或**对方为未锁定的黑洞**，调用`handleMove`执行合并/特殊效果；
2. 移动阶段：遍历棋盘，将非空方块向指定方向移动，填充空位，保证方块紧贴棋盘边缘，未锁定的障碍物会阻挡方块移动；
3. （移动后）处理阶段：调用`emitSignal`判定游戏状态（胜利/失败/继续），调用`gen`随机生成新的方块，调用`saveFile`保存当前步骤。

##### （2）合并方块效果：handleMove
该函数是**游戏规则的核心**，处理不同类型方块的碰撞逻辑，覆盖所有扩展功能。根据移动方向可把合并 的两个方块视为碰撞者（`snd`）和被碰撞者（`fst`）：

+ 数字方块：相同数值的数字方块合并，数值翻倍，分数增加合并后的数值，即经典2048计分规则；
+ 黑洞方块：碰撞后清空自身和对方的数值，无计分；
+ LG2对数方块：碰撞数字方块时，将数字方块的数值转换为2的对数（如8→3），清空碰撞者；
+ 位运算方块（AND/OR/XOR）：碰撞数字方块时，将自身数值与数字方块数值执行对应位运算，结果赋值给被碰撞者，清空碰撞者；
+ 炸弹方块：不参与碰撞，仅通过鼠标解锁触发效果。

##### （3）方块生成：generate/gen
+ `generate`：核心生成函数，接收各类型方块的生成概率，随机选择空位生成方块，数字方块生成概率随最大方块值动态调整，特殊方块仅在最大方块值≥8时生成；
+ `gen`：根据当前棋盘的最大方块值`maxVal`动态设置生成概率：
    - 最大方块≤2：仅生成1（90%）和2（10%），基础难度；
    - 最大方块=4：生成1（50%）、2（40%）、4（10%）；
    - 最大方块=8：生成1/2/4/8；
    - 最大方块≥16：加入特殊方块（炸弹/位运算/黑洞/LG2）。

##### （4）胜利/失败判定：check/emitSignal
+ `check`：遍历棋盘判定游戏状态，是游戏结束的核心逻辑：
    1. 若存在空位→游戏继续；
    2. 若存在2048方块→游戏胜利；
    3. 若棋盘填满且存在特殊方块→游戏继续（特殊方块可触发效果创造空位）；
    4. 若棋盘填满且无相邻相同数字方块→游戏失败；
+ `emitSignal`：根据`check`的结果，发射`win`/`lose`信号通知界面层，触发结算逻辑。

#### 4. 扩展功能实现
##### （1）炸弹效果：Bomb
接收界面层的`bomb`信号，清空炸弹方块自身及**上下左右**共5个格子的数值，创造棋盘空位，无计分。

##### （2）步数撤回：recoverLastStep
实现**上一步撤回**功能，核心依赖`data/save/file.json`的步骤数据文件：

1. 步骤文件中存储了每一步的棋盘数据、分数；
2. 撤回时读取上一步的步骤数据，恢复棋盘、分数，删除当前步骤的记录，步数减1；
3. 仅在步数≥1时可执行，避免无效操作。

##### （3）数据保存与清空：saveFile/clearFile
+ `saveFile`：每一步操作后，将当前的**分数、棋盘所有方块的类型/锁定状态/数值**写入步骤文件`file.json`，为撤回和存档提供数据支撑；
+ `clearFile`：新游戏开始时清空步骤文件，避免历史数据干扰。

#### 5. 辅助功能
+ `is2Times`：判断一个数是否为2的幂次，用于数字方块的合法性校验；
+ `lg2`：计算一个数的2的对数，为LG2方块提供算法支持；
+ `debData`：调试函数，打印棋盘所有数据，便于开发阶段的问题排查；
+ 计时器：通过`QTimer`实现1秒一次的计时，`addTime`槽函数更新用时，`suspend/goOn/start`实现计时器的暂停/继续/启动。

### （四）数据保存模块
**核心功能**：通过**JSON格式**实现游戏数据的本地存储，包含**排行榜数据、游戏步骤数据、存档数据**三类，所有文件均存储在程序运行目录的`data`文件夹下，Qt的`QJsonDocument/QJsonArray/QJsonObject`实现JSON的解析与生成。

1. **排行榜数据**：`data/rank.json`，存储所有玩家的姓名、分数、时间，但最后只显示前六名；
2. **游戏步骤数据**：`data/save/file.json`，存储每一步的棋盘数据、分数，为撤回和存档提供原始数据，新游戏清空、读档恢复；
3. **存档数据**：`data/save/historySavings/HistoryFilex.json`，每个存档为独立的json文件，包含该存档的所有步骤数据、玩家名、用时、得分、步数，支持多存档存储。

**文件操作特点**：所有文件操作均做**存在性校验**，若文件/目录不存在则自动创建，避免程序崩溃；写入文件时使用`Truncate`模式，覆盖原有数据，保证数据的最新性。

## 三、玩法介绍
### 1. 启动与准备
+ 游戏启动后进入初始界面，点击**开始游戏**，输入玩家名称即可开启新游戏；点击**读取存档**可选择历史游戏进度继续游玩；点击**游戏帮助**可快速查看基础规则。
+ 游戏主界面包含4×4核心棋盘、实时计时/计分/步数显示、排行榜区域，以及**暂停/继续、撤回上一步、保存游戏、重新开始、退出游戏**功能按钮。

### 2. 核心操控方式
支持**键盘按键**和**界面按钮**双操作模式，键盘操作更贴合游玩习惯，推荐优先使用：

| 按键/按钮 | 功能效果 | 补充说明 |
| --- | --- | --- |
| W | 所有可移动方块向上移动 | 移动后满足合并条件则自动合并，棋盘变化后生成新方块 |
| S | 所有可移动方块向下移动 | 同上 |
| A | 所有可移动方块向左移动 | 同上 |
| D | 所有可移动方块向右移动 | 同上 |
| R | 重新开启游戏 | 本局分数会被记录至排行榜，确认后重新开始游戏。只有游戏进行中可以通过R快捷键重新开始游戏。 |
| Q | 退出当前游戏 | 返回初始界面，本局分数正常记录。只有游戏进行中可以通过Q快捷键结束游戏。 |
| 暂停/继续按钮 | 暂停/恢复游戏 | 暂停后计时器停止，棋盘无任何操作响应 |
| 上一步按钮 | 撤销上一次移动操作 | 仅在步数≥1时可用，恢复上一步的棋盘、分数和步数 |
| 存档按钮 | 保存当前游戏进度 | 自动生成存档文件，可在读档界面通过左键单击对应存档继续游玩 |


### 3. 初始生成规则
新游戏开始时，系统将在棋盘**两个随机不同空位**生成初始数字方块，生成概率严格遵循：**90%概率生成十进制1（0001）、10%概率生成十进制2（0010）**，生成后计时器开始正计时。

### 4.移动与合并
1. **移动规则**：按下方向键后，所有未被锁定的方块将向指定方向**移动至紧贴棋盘边缘或被锁定方块阻挡**，空位由后方方块依次填充。
2. **合并规则**：移动过程中，**相邻且数值相同的数字方块**会自动合并，合并后生成**原数值2倍**的新方块（二进制左移一位），例如0001+0001=0010、0100+0100=1000。特殊方块见**特殊方块玩法**。
3. **合并限制**：每一次移动中，每个方块最多仅能参与一次合并。
4. **新方块生成**：每次移动后，若棋盘的方块位置/数值发生变化，系统将在**随机空位**生成新方块。

### 5. 计分规则
计分以**十进制**为基准，**每次成功合并时，分数增加「合并后新方块的十进制数值」**，未合并则分数不变。

### 6. 胜利与失败判定
#### （1）胜利条件
棋盘内**任意格子合成十进制2048方块（二进制100000000000）**，判定游戏胜利，弹出结算提示框，显示本局用时、得分、最大方块。

#### （2）失败条件
棋盘被方块完全填满，且**向上下左右任意方向移动均无法实现方块合并，也无特殊功能方块可触发效果创造空位**，判定游戏失败（Game Over），弹出结算提示框。

### 7. 计时规则
+ 计时器从游戏开始生成初始方块时启动，**精确到秒**，显示格式为「X分钟X秒」，实时更新在游戏界面。
+ 计时器在**游戏胜利、游戏失败、玩家主动退出、暂停游戏、重新开始**时自动停止，恢复游戏（继续按钮）时从停止时间继续计时。

### 8.特色功能方块玩法
在经典数字方块基础上，游戏新增**6种特色功能方块和1种障碍物方块**，当棋盘最大方块值≥16时，将特色功能方块有概率出现，为游戏增加策略性和不确定性。所有功能方块**默认锁定状态**，点击方块可解锁（解锁后标注「Unlocked」，锁定状态标注「Locked」），解锁后参与移动/碰撞并触发对应效果，部分方块触发效果后消失。根据移动方向可把合并 的两个方块视为碰撞者（`snd`）和被碰撞者（`fst`）

##### 1. 位运算方块（AND/OR/XOR）
包含与（AND）、或（OR）、异或（XOR）三种，解锁后移动至与数字方块相邻时，触发**位运算效果**：以方块自身十进制数值为基准，与相邻数字方块的数值执行对应位运算，结果替换`fst`方块数值，`snd`方块变为空位。

##### 2. 炸弹方块（BOMB）
解锁后**立即**触发炸弹效果：清空自身所在格子及**上下左右相邻共5个格子**的所有方块（数字/功能方块障碍物均清空），变为空位，无任何计分。

##### 3. 黑洞方块（BLACKHOLE）
解锁后移动至与任意方块相邻时，触发**吞噬效果**：将自身和相邻方块均清空为空位，无任何计分

##### 4. 对数方块（LG2）
解锁后移动至与数字方块相邻时，触发**对数转换效果**：将相邻**数字**方块的十进制数值转换为其相应的对数，结果替换`fst`方块自身数值，`snd`方块变为空位。

##### 5. 障碍物方块（BARRIER）
当数字方块经过位运算/对数运算后得到的结果不再是二的次方，该方块将永久处于**锁定状态**，无法点击解锁、无法移动、无法合并，只有**炸弹方块/黑洞方块**可以去除。

### 9. 步数撤回
游戏记录每一步的棋盘状态、分数和步数，点击**撤回上一步**按钮，可恢复至**上一次移动前的游戏状态**，步数、分数同步回退，仅在当前步数≥1时可用。

### 10. 存档与读档
+ **保存存档**：游戏过程中任意时刻点击**存档**，系统将当前棋盘状态、玩家名、用时、得分、步数自动保存为独立存档文件，可生成多个历史存档，互不干扰。
+ **读取存档**：在初始界面点击**读取存档**，进入存档列表界面，选择对应存档即可继续游玩，存档列表清晰显示每个存档的玩家名、用时、得分、步数，支持**单个存档删除**（右键单击）和**清空所有存档**。

### 11. 排行榜系统
+ 排行榜自动记录历史游戏的**前6名成绩**，排序规则为：**分数高者优先；分数相同时，用时更短者排名靠前**，实时显示在游戏主界面，包含排名、玩家名、总分、用时信息。
+ 每局游戏结束（胜利/失败/重新开始/退出）后，本局成绩将自动参与排行榜排序

## 四、本地运行结果
### 游戏开始
<!-- 这是一张图片，ocr 内容为： 游戏开始>
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772180876217-d5e7bd65-a115-46b7-bc4d-3b15e41747fb.png)

### 游戏界面
+ 初始界面

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772180895009-ad498713-4583-4a8b-b11e-7afdc7125aff.png)

+ 各类方块示意

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772181066424-1e57be31-d273-4839-9684-91179d4086f6.png)

+ 退出游戏/重新开始后排行更新

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772181132332-1015e215-39e9-41d7-aa1b-2a1bd39691b4.png)

### 读档界面
+ 存档页面

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772181180258-b425d3cf-d757-4b4d-96d9-1cd069e7b5e7.png)

+ 清除单个存档：右键单击想要删除的存档

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772181242525-e0d2f57f-7d74-4e49-8769-9bd38510f518.png)

+ 清除全部存档，点击确定后所有存档将被删除

<!-- 这是一张图片，ocr 内容为： -->
![](https://cdn.nlark.com/yuque/0/2026/png/47958046/1772181294060-0c29386e-67bb-40f3-8e4e-76c8bf2e8e39.png)



